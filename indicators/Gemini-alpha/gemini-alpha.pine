//@version=5
indicator("Gemini QUANTUM [SMC + Trend]", overlay=true, max_boxes_count=500, max_lines_count=500, shorttitle="G-QUANTUM")

// ==========================================
// ─── SETTINGS ───
// ==========================================
grp_trend = "Trend Strategy"
src = input.source(close, "Source", group=grp_trend)
per = input.int(50, "Period", minval=1, group=grp_trend)
mult = input.float(2.0, "Multiplier", minval=0.1, step=0.1, group=grp_trend)

grp_smc = "Smart Money Concepts (SMC)"
show_fvg = input.bool(true, "Show FVG (Fair Value Gaps)", group=grp_smc)
show_ob = input.bool(true, "Show Order Blocks (Support/Resistance)", group=grp_smc)
ob_period = input.int(10, "Order Block Pivot Period", group=grp_smc)

grp_vis = "Visuals"
show_dash = input.bool(true, "Show Dashboard", group=grp_vis)
color_bars = input.bool(true, "Colorize Candles", group=grp_vis)

// ==========================================
// ─── 1. TREND ENGINE (Range Filter) ───
// ==========================================
var float smoothrng = 0.0
var float filter = 0.0
var int direction = 0

wper = per * 2 - 1
avrng = ta.ema(math.abs(src - src[1]), per)
smoothrng := ta.ema(avrng, wper) * mult

if src > filter
    filter := math.max(filter, src - smoothrng)
else if src < filter
    filter := math.min(filter, src + smoothrng)
else
    filter := filter

if src > filter
    direction := 1
else if src < filter
    direction := -1

bool buy_sig = direction == 1 and direction[1] == -1
bool sell_sig = direction == -1 and direction[1] == 1

// Plot Trend Line
plot(filter, color=direction == 1 ? color.new(#00E676, 20) : color.new(#FF5252, 20), linewidth=2, title="Trend Baseline")

// Plot Buy/Sell Labels
plotshape(buy_sig, title="BUY", text="BUY", style=shape.labelup, location=location.belowbar, color=color.new(#00E676, 0), textcolor=color.black, size=size.tiny)
plotshape(sell_sig, title="SELL", text="SELL", style=shape.labeldown, location=location.abovebar, color=color.new(#FF5252, 0), textcolor=color.white, size=size.tiny)

// Candle Coloring
barcolor(color_bars ? (direction == 1 ? color.new(#00E676, 0) : color.new(#FF5252, 0)) : na)

// ==========================================
// ─── 2. FVG (FAIR VALUE GAPS) ───
// ==========================================
// Detects imbalances in price (3-candle pattern)

bool is_bull_fvg = low > high[2] and show_fvg
bool is_bear_fvg = high < low[2] and show_fvg

if is_bull_fvg
    box.new(bar_index[2], low, bar_index + 5, high[2], border_color=color.new(color.green, 80), bgcolor=color.new(color.green, 90), text="FVG", text_size=size.tiny, text_color=color.new(color.green, 40))

if is_bear_fvg
    box.new(bar_index[2], low[2], bar_index + 5, high, border_color=color.new(color.red, 80), bgcolor=color.new(color.red, 90), text="FVG", text_size=size.tiny, text_color=color.new(color.red, 40))

// ==========================================
// ─── 3. ORDER BLOCKS / ZONES ───
// ==========================================
// Creates extended boxes for Support (Buy Zone) and Resistance (Sell Zone)

ph = ta.pivothigh(ob_period, ob_period)
pl = ta.pivotlow(ob_period, ob_period)

// Resistance Zone (Previous Highs)
if not na(ph) and show_ob
    // Draw box from pivot to future
    box.new(bar_index[ob_period], ph, bar_index + 30, ph * 1.002, border_color=na, bgcolor=color.new(#FF5252, 85), text="SELL ZONE", text_size=size.tiny, text_color=color.new(#FF5252, 20))

// Support Zone (Previous Lows)
if not na(pl) and show_ob
    // Draw box from pivot to future
    box.new(bar_index[ob_period], pl, bar_index + 30, pl * 0.998, border_color=na, bgcolor=color.new(#00E676, 85), text="BUY ZONE", text_size=size.tiny, text_color=color.new(#00E676, 20))


// ==========================================
// ─── 4. DASHBOARD ───
// ==========================================
var table dash = table.new(position.top_right, 3, 4, bgcolor=color.new(color.black, 50), border_width=1)

if show_dash and barstate.islast
    table.cell(dash, 0, 0, "GEMINI QUANTUM", bgcolor=color.black, text_color=color.white, width=12)
    
    // Row 1: Trend
    table.cell(dash, 0, 1, "TREND", text_color=color.white, text_halign=text.align_left)
    table.cell(dash, 1, 1, direction == 1 ? "BULLISH" : "BEARISH", bgcolor=direction==1 ? #00E676 : #FF5252, text_color=color.white)
    
    // Row 2: Volatility
    volatility = (high - low) / close * 100
    table.cell(dash, 0, 2, "VOLATILITY", text_color=color.white, text_halign=text.align_left)
    table.cell(dash, 1, 2, str.tostring(volatility, "#.##") + "%", text_color=color.white)

    // Row 3: Signal
    table.cell(dash, 0, 3, "SIGNAL", text_color=color.white, text_halign=text.align_left)
    table.cell(dash, 1, 3, direction == 1 ? "LONG" : "SHORT", text_color=direction == 1 ? #00E676 : #FF5252)

// ==========================================
// ─── ALERTS ───
// ==========================================
alertcondition(buy_sig, "Quantum BUY", "Quantum BUY Signal Detected")
alertcondition(sell_sig, "Quantum SELL", "Quantum SELL Signal Detected")